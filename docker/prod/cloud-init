#cloud-config

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - git
  - gnupg
  - lsb-release

write_files:
  - path: /opt/shortener/start.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      APP_DIR="/opt/shortener/app"
      REPO_URL="https://github.com/weversonl/spring-url-shortener.git"
      BRANCH="main"
      COMPOSE_DIR="${APP_DIR}/docker/prod"
      COMPOSE_FILE="docker-compose-prod.yaml"

      if [ ! -d "${APP_DIR}/.git" ]; then
        mkdir -p "${APP_DIR}"
        git clone --depth 1 --branch "${BRANCH}" "${REPO_URL}" "${APP_DIR}"
      else

        cd "${APP_DIR}"
        git fetch --all --prune
        git reset --hard "origin/${BRANCH}"
      fi

      cd "${COMPOSE_DIR}"

      docker compose -f "${COMPOSE_FILE}" pull || true
      docker compose -f "${COMPOSE_FILE}" up -d --remove-orphans

  - path: /etc/systemd/system/shortener.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Shortener stack (Docker Compose - prod)
      Wants=network-online.target
      After=network-online.target docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/shortener/app/docker/prod
      ExecStart=/opt/shortener/start.sh
      ExecStop=/usr/bin/docker compose -f docker-compose-prod.yaml down
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target

runcmd:
  - |
    set -e
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
      > /etc/apt/sources.list.d/docker.list
    apt-get update -y
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  - systemctl enable --now docker
  - systemctl daemon-reload
  - systemctl enable --now shortener.service
  - systemctl start shortener.service
